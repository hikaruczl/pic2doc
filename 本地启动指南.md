# 🚀 本地启动指南

## 问题说明

**代理冲突**: httpx 不支持 socks 代理，会报错：
```
ValueError: Unknown scheme for proxy URL URL('socks://127.0.0.1:7897/')
```

## ✅ 解决方案

已创建启动脚本，自动清除代理环境变量。

---

## 🎯 一键启动（推荐）

启动所有服务（数据库 + 后端 + 前端）：

```bash
cd /mnt/vdb/dev/advanceOCR
./start_all.sh
```

**服务访问地址**:
- 前端: http://localhost:5173
- 后端: http://localhost:8005
- 数据库: localhost:5433

---

## 🔧 分步启动

### 1. 启动数据库和 Redis
```bash
cd /mnt/vdb/dev/advanceOCR
sudo docker compose -f docker/docker-compose.yml up -d postgres redis
```

### 2. 启动后端
```bash
./start_backend.sh
```

### 3. 启动前端
```bash
./start_frontend.sh
```

---

## 📝 查看日志

```bash
# 后端日志
tail -f logs/backend.log

# 前端日志
tail -f logs/frontend.log

# 数据库日志
sudo docker compose -f docker/docker-compose.yml logs -f postgres
```

---

## 🛑 停止服务

```bash
# 停止后端
pkill -f "python.*web/backend/app.py"

# 停止前端
pkill -f "vite"

# 停止数据库和 Redis
sudo docker compose -f docker/docker-compose.yml stop postgres redis
```

或者一键停止所有：
```bash
pkill -f "python.*app.py"
pkill -f "vite"
sudo docker compose -f docker/docker-compose.yml down
```

---

## 🧪 验证修复

### 1. 后端 API 测试
```bash
curl http://localhost:8005/
```

应该返回 JSON 响应。

### 2. 上传图片测试

1. 打开浏览器: http://localhost:5173
2. 上传之前失败的图片
3. 检查生成的 Word 文档：
   - ✅ `ar{x}1` 显示为 x̄₁
   - ✅ `y_02` 和 `x_02` 显示为 y₀² 和 x₀²
   - ✅ 矩阵括号正确（圆括号、方括号、竖线）

---

## 📊 已修复的问题总结

### ✅ 问题1: OCR 错误修复
- `ar{x}1` → `\bar{x}_1` ✅
- `y_02` → `y_0^2` ✅ (无空格情况)
- `x_02` → `x_0^2` ✅
- 控制字符清理 ✅

**文件**: `src/formula_converter.py`

### ✅ 问题2: 矩阵括号
- pmatrix: 圆括号 `()` ✅
- bmatrix: 方括号 `[]` ✅
- vmatrix: 竖线 `||` ✅

**文件**: `src/document_generator.py`

### ⏳ 问题3: TikZ 3D 图形
- 代码已集成 ✅
- 需要实际测试

**文件**: `src/tikz_renderer.py`, `config/config.yaml`

### ✅ Docker 构建问题
- 修复 Alpine/Rollup 兼容性 ✅
- 使用 node:18-slim 代替 alpine ✅

**文件**: `Dockerfile.frontend`, `docker/Dockerfile.frontend`

### ✅ 代理冲突问题
- 启动脚本自动清除 socks 代理 ✅
- httpx 兼容性问题已解决 ✅

---

## 🔍 故障排查

### 后端启动失败？

**检查日志**:
```bash
tail -50 logs/backend.log
```

**常见问题**:
1. **代理错误**: 确保使用 `./start_backend.sh` 启动
2. **数据库连接失败**: 确保 PostgreSQL 容器在运行
   ```bash
   sudo docker compose -f docker/docker-compose.yml ps
   ```
3. **权限错误**: 确保日志目录权限正确
   ```bash
   sudo chown -R ctyun:ctyun logs/
   ```

### 前端启动失败？

**检查日志**:
```bash
tail -50 logs/frontend.log
```

**常见问题**:
1. **端口占用**: 5173 端口被占用
   ```bash
   lsof -i :5173
   ```
2. **依赖缺失**: 重新安装
   ```bash
   cd web/frontend && npm install
   ```

---

## 📦 完整 Docker 部署

如果要使用 Docker 部署（而不是本地开发）:

```bash
./start_docker.sh
```

这会构建并启动完整的 Docker 容器（包括前端和后端）。

---

**最后更新**: 2025-10-12 22:50
**状态**: ✅ 所有已知问题已修复
